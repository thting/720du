<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>首页</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/other.css" />
</head>
<body>
    <div class="main">
        <div id="js-main-map" class="main-map">
        </div>

        <div id="js-dialog" class="map-dialog">
            <div class="map-dlog-cont">
                <div class="map-dlog-tabs">
                    <div class="active">地铁商铺</div>
                    <div>美食餐饮</div>
                    <div>休闲娱乐</div>
                    <div>周边景点</div>
                    <div>友你会</div>
                </div>
                <div class="map-dlog-slide">
                    <div class="active">
                        <div class="map-dlog-hdiv">
                            <div class="map-dlog-station map-dlog-stntext">龙胜站</div>
                            <img id="js-dlog-newmsg" class="map-dlog-nmsg" src="img/new_msg.png" />
                        </div>
                        <div class="map-dlog-cdiv">
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                            <img src="img/store_info.png" style="width:85%;margin:10px 0;" />
                        </div>
                    </div>
                    <div>
                        <div class="map-dlog-hdiv">
                            <div class="map-dlog-station map-dlog-stntext">龙胜站</div>
                        </div>
                        <div class="map-dlog-cdiv">
                            美食餐饮
                        </div>
                    </div>
                    <div>
                        <div class="map-dlog-hdiv">
                            <div class="map-dlog-station map-dlog-stntext">龙胜站</div>
                        </div>
                        <div class="map-dlog-cdiv">
                            休闲娱乐
                        </div>
                    </div>
                    <div>
                        <div class="map-dlog-hdiv">
                            <div class="map-dlog-station map-dlog-stntext">龙胜站</div>
                        </div>
                        <div class="map-dlog-cdiv">
                            周边景点
                        </div>
                    </div>
                    <div>
                        <div class="map-dlog-hdiv">
                            <div class="map-dlog-station"></div>
                        </div>
                        <div class="map-dlog-cdiv">
                            <img src="img/unh.jpg" style="width:100%;" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="js-dlog-storeinfo" class="map-dialog">
            <div class="map-dlog-cont storeinfo">
                <div class="map-dlog-wrapper">
                    <img class="dlog-storeinfo-img" src="img/store_info2.png" />
                </div>
            </div>
        </div>

        <div id="js-dlog-collect-info" class="map-dialog">
            <div class="map-dlog-cont collect-info">
                <div class="map-dlog-wrapper">
                    <img class="dlog-collect-info" src="img/cellect_info.png" />
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript" src="js/zepto.min.1.1.6.js"></script>
    <script src="js/css3d.min.js"></script>
    <script src="js/hammer.min.js"></script>
    <script src="js/index.js"></script>
    <script>

        var js_main_map = $("#js-main-map");
        var stage = new C3D.Stage();
        stage.material({
            color: "#141821"
        })
        js_main_map.append(stage.el)
        function resize() {
            stage.size(window.innerWidth, window.innerHeight).update();
        }
        resize();
        var fov = stage.fov;

        function random(max, haf) {
            if (haf) {
                return Math.floor(Math.random() * max - max / 2);
            }
            return Math.floor(Math.random() * max);
        }

        var distancgroup = new C3D.Sprite();
        distancgroup.position(0, 0, -fov).update();
        //distancgroup.el.className = "main-group"
        stage.addChild(distancgroup);

        var maingroup = new C3D.Sprite();
        maingroup.scale(0.6).update();
        distancgroup.addChild(maingroup);

        function maingroup_updateT() {
            maingroup.updateT();
        }

        (function () {

            //var ptext1 = new C3D.Plane();
            //ptext1.el.innerHTML = '<div class="test-leveldiv" > flag xyz 000 </div>';
            //ptext1.update();
            //maingroup.addChild(ptext1);

            var map_width = 3072;
            var map_height = 1052;

            var imgs = [
                //{ x: 0, y: 0, z: -1, w: 3072, h: 1052, s: 1, n: "mask.jpg" },
                { x: 0, y: 0, z: 0, w: 768, h: 263, s: 4, n: "bg.png" },

                { x: -1382, y: -361, z: 10, w: 227, h: 193, s: 1, n: "z1.png" },
                { x: -905, y: -276, z: 50, w: 920, h: 500, s: 1, n: "z2.png" },
                { x: -469, y: -340, z: 0, w: 578, h: 302, s: 1, n: "z3.png" },
                { x: -55, y: -294, z: 50, w: 584, h: 444, s: 1, n: "z4.png" },
                { x: 427, y: -245, z: 90, w: 641, h: 562, s: 1, n: "z5.png" },
                { x: 894, y: -394, z: 30, w: 234, h: 407, s: 1, n: "z6.png" },
                { x: 1377, y: -377, z: 10, w: 592, h: 473, s: 1, n: "z7.png" },
                { x: 1445, y: -125, z: 110, w: 227, h: 193, s: 1, n: "z8.png" },
                { x: 875, y: -123, z: 120, w: 476, h: 305, s: 1, n: "z9.png" },
                { x: 172, y: -32, z: 50, w: 373, h: 164, s: 1, n: "z10.png" },
                { x: -527, y: -104, z: 110, w: 553, h: 227, s: 1, n: "z11.png" },
                { x: -1189, y: -107, z: 120, w: 506, h: 297, s: 1, n: "z12.png" },
                { x: -154, y: -145, z: 70, w: 3399, h: 269, s: 1, n: "z13.png" },
                { x: -1248, y: 416, z: 50, w: 749, h: 233, s: 1, n: "z14.png" },
                { x: -489, y: 416, z: 70, w: 564, h: 298, s: 1, n: "z15.png" },
                { x: -263, y: 376, z: 10, w: 373, h: 164, s: 1, n: "z16.png" },
                { x: 237, y: 401, z: 80, w: 367, h: 250, s: 1, n: "z17.png" },
                { x: 589, y: 397, z: 30, w: 503, h: 258, s: 1, n: "z18.png" },
                { x: 990, y: 358, z: 70, w: 344, h: 335, s: 1, n: "z19.png" },
                { x: 1359, y: 415, z: 30, w: 454, h: 242, s: 1, n: "z20.png" },

                //{ x: -1032, y: -283, z: 69, w: 888, h: 72, s: 1, n: "z21.png" },


                // 人物
                { x: -861, y: 416, z: 100, w: 273, h: 222, s: 1, n: "r1.png" },
                { x: 17, y: 408, z: 40, w: 280, h: 234, s: 1, n: "r2.png" },
                { x: 840, y: -21, z: 140, w: 173, h: 186, s: 1, n: "r3.png" },
                { x: -1346, y: 142, z: 150, w: 273, h: 298, s: 1, n: "r4.png" },
                { x: -136, y: -61, z: 90, w: 75, h: 129, s: 1, n: "r5.png" },
                { x: -65, y: -60, z: 90, w: 56, h: 130, s: 1, n: "r6.png" },
                { x: 397, y: 46, z: 130, w: 114, h: 150, s: 1, n: "r7.png" },
                { x: -183, y: 418, z: 40, w: 137, h: 216, s: 1, n: "r8.png" },
                { x: 1170, y: -107, z: 70, w: 90, h: 159, s: 1, n: "r9.png" },
                { x: -844, y: -119, z: 70, w: 67, h: 172, s: 1, n: "r10.png" },
                { x: 76, y: -11, z: 70, w: 107, h: 121, s: 1, n: "r11.png" },
                { x: 645, y: -21, z: 120, w: 59, h: 126, s: 1, n: "r12.png" },


                //线路
                { x: 81, y: 134, z: 130, w: 2509, h: 240, s: 1, n: "p1.png" },
                { x: -1153, y: -27, z: 130, w: 106, h: 175, s: 1, n: "p2.png" },
                { x: 1315, y: -87, z: 130, w: 110, h: 158, s: 1, n: "p3.png" },
            ]

            var station = [
                //站点
                { x: -1148, y: 83, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "福田口岸" },
                { x: -961, y: 56, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "福民" },
                { x: -779, y: 75, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "会展中心" },
                { x: -616, y: 91, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "市民中心" },
                { x: -442, y: 80, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "少年宫" },
                { x: -268, y: 68, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "莲花北" },
                { x: -96, y: 59, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "上梅林" },
                { x: 62, y: 237, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "民乐", t: true },
                { x: 251, y: 241, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "白石龙", t: true },
                { x: 424, y: 241, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "深圳北站", t: true },
                { x: 596, y: 242, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "红山", t: true },
                { x: 791, y: 240, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "上塘", t: true },
                { x: 942, y: 29, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "龙胜" },
                { x: 1126, y: 26, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "龙华" },
                { x: 1309, y: 27, z: 0, w: 53, h: 53, s: 1, n: "p4.png", m: "清湖" },
            ]


            for (var i = 0; i < imgs.length; i++) {
                var item = imgs[i];
                var p = new C3D.Plane();
                p.size(item.w, item.h).position(item.x, item.y, item.z - 80).scale(item.s).material({
                    image: "pic/" + item.n
                }).update();
                maingroup.addChild(p)
            }

            for (var i = 0; i < station.length; i++) {
                var item = station[i];
                var p = new C3D.Plane();
                p.size(item.w, item.h).position(item.x, item.y, item.z + 50).scale(item.s).material({
                    image: "pic/" + item.n
                }).update();
                p.el.className = "station-tag"
                p.el.tagname = item.m;
                if (item.m)
                    p.el.innerHTML = '<div class="map-stt-name ' + (item.t ? 'set-top' : '') + '" >' + item.m + '</div>';
                maingroup.addChild(p)
            }


            var subway = new C3D.Sprite();
            subway.position(0, 0, 69 - 80).update();
            subway.el.innerHTML = '<div class="ani-subway"></div>';
            maingroup.addChild(subway);


            //[-2270, -276]
            //[-150,-290]
            //[1970,-309]



            var car = new C3D.Sprite();
            car.el.className = "ani-car-transition"
            car.position(-961, 56, 51).update();
            var carbody = new C3D.Plane();
            carbody.size(135, 40).position(0, 0, 0).material({
                image: "pic/c1.png"
            }).update();
            car.addChild(carbody);
            var carlight = new C3D.Plane();
            carlight.size(64, 41).position(-89, 0, 0).material({
                image: "pic/c2.png"
            }).update();
            carlight.el.className = "ani-car-light"
            car.addChild(carlight);
            var carlight2 = new C3D.Plane();
            carlight2.size(64, 41).position(89, 0, 0).rotate(0, 0, 180).material({
                image: "pic/c2.png"
            }).update();
            carlight2.el.className = "ani-car-light"
            car.addChild(carlight2);

            window.car = car;

            maingroup.addChild(car);





            var vector2deg = function () {
                var radianToDegreesFactor = 180 / Math.PI;
                return function (x, y) {
                    if (x == 0 && y == 0) {
                        return 360;
                    }
                    rad = Math.atan(y / x);
                    var result = rad * radianToDegreesFactor;
                    if (x < 0) {
                        result += 180;
                    }
                    if (result < 0) {
                        result += 360;
                    }
                    return result;
                }
            }();

            var big, small;
            for (var i = 0; i < station.length; i++) {
                small = station[i - 1];
                if (i == 0) {
                    small = station[i];
                }
                big = station[i + 1];
                if (i + 1 == station.length) {
                    big = station[i]
                }
                station[i].r = vector2deg(big.x - small.x, big.y - small.y);
            }






            var last_idx = 0;
            maingroup_updateT = function () {
                maingroup.updateT();
                var x = -maingroup.x / maingroup.scaleX;
                var last_x = station[last_idx].x;

                if (x < last_x) {
                    var small_idx = 0;
                    for (var i = last_idx - 1; i >= 0; i--) {
                        if (station[i].x < x) {
                            small_idx = i;
                            break;
                        }
                    }
                    if (x - station[small_idx].x < last_x - x) {
                        last_idx = small_idx;
                        var item = station[small_idx]
                        car.x = item.x;
                        car.y = item.y;
                        //car.rotationZ = item.r;
                        car.updateT();
                    }

                } else if (x > last_x) {

                    var big_idx = station.length - 1;
                    for (var i = last_idx + 1; i < station.length; i++) {
                        if (station[i].x > x) {
                            big_idx = i;
                            break;
                        }
                    }
                    if (station[big_idx].x - x < x - last_x) {
                        last_idx = big_idx;
                        var item = station[big_idx]
                        car.x = item.x;
                        car.y = item.y;
                        //car.rotationZ = item.r;
                        car.updateT();
                    }
                }
            }

            maingroup_updateT();




        })();


        $("#js-main-map").on("click", ".station-tag", function () {

            $("#js-dialog").addClass("show");
            $(".map-dlog-stntext").text(this.tagname)
        });

        $(".map-dialog").click(function (e) {
            if (e.target == this)
                $(this).removeClass("show");
        });

        $(".map-dlog-tabs>div").click(function (e) {
            var $this = $(this);
            var idx = $this.index();
            $this.addClass("active").siblings(".active").removeClass("active");
            $("div.map-dlog-slide>div").eq(idx).addClass("active").siblings(".active").removeClass("active");

        });

        $(".map-dlog-cdiv").on("click", "img", function () {
            $("#js-dlog-storeinfo").addClass("show");
        });
        $("#js-dlog-newmsg").click(function () {
            $("#js-dlog-collect-info").addClass("show");
        });





        (function () {

            return;


            var level3 = new C3D.Sprite();
            level3.position(0, 0, -1200).update();
            maingroup.addChild(level3);

            var level2 = new C3D.Sprite();
            level2.position(0, 0, -600).update();
            maingroup.addChild(level2);

            var level2_bgplane;

            var level1 = new C3D.Sprite();
            level1.position(0, 0, 0).update();
            maingroup.addChild(level1);




            var ptext1 = new C3D.Plane();
            ptext1.el.innerHTML = '<div class="test-leveldiv" >第一层</div>';
            ptext1.update();
            level1.addChild(ptext1);

            var ptext2 = new C3D.Plane();
            ptext2.el.innerHTML = '<div class="test-leveldiv" >第二层</div>';
            ptext2.z = 10;
            ptext2.update();
            level2.addChild(ptext2);

            var ptext3 = new C3D.Plane();
            ptext3.el.innerHTML = '<div class="test-leveldiv" >第三层</div>';
            ptext3.update();
            level3.addChild(ptext3);


            //for (var i = 0; i < 30; i++) {
            //    var p = new C3D.Plane();
            //    var pd = '<div class="test-textdiv" >' + "第一层的随机标签" + i + '</div>';
            //    p.el.innerHTML = pd;
            //    p.position(random(800, 1), random(800, 1), random(200,1)).rotation(0, 0, 0).material({
            //        color: C3D.getRandomColor()
            //    }).update();
            //    level1.addChild(p)
            //}

            //for (var i = 0; i < 30; i++) {
            //    var p = new C3D.Plane();
            //    var pd = '<div class="test-textdiv" >' + "第二层的随机标签" + i + '</div>';
            //    p.el.innerHTML = pd;
            //    p.position(random(800, 1), random(800, 1), random(200, 1)+100).rotation(0, 0, 0).material({
            //        color: C3D.getRandomColor()
            //    }).update();
            //    level2.addChild(p)
            //}
            var p = new C3D.Plane();
            p.size(2688, 1344).position(0, 0, 0).material({
                image: "img/m2.jpg"
            }).update();
            level2.addChild(p)
            level2_bgplane = p;

            //for (var i = 0; i < 30; i++) {
            //    var p = new C3D.Plane();
            //    var pd = '<div class="test-textdiv" >' + "第三层的随机标签" + i + '</div>';
            //    p.el.innerHTML = pd;
            //    p.position(random(1600, 1), random(1600, 1), random(200, 1)).rotation(0, 0, 0).material({
            //        color: C3D.getRandomColor()
            //    }).update();
            //    level3.addChild(p)
            //}




            //for (var i = 0; i < 200; i++) {
            //    var c = new C3D.Box();
            //    c.size(20).position(random(600,1), random(600,1), random(200,1)).rotation(0, 0, random(90)).material({
            //        color: C3D.getRandomColor()
            //    }).update();
            //    maingroup.addChild(c);
            //}
        })();


        $(window).resize(function () {
            resize();
        });
        var touchhammer = new Hammer(js_main_map[0], {});
        touchhammer.get('pan').set({ direction: Hammer.DIRECTION_ALL, threshold: 0, });
        //touchhammer.get('pinch').set({ enable: true });
        var panstartx, panstarty;
        touchhammer.on('panstart', function (ev) {
            panstartx = 0;
            panstarty = 0;
        });
        touchhammer.on('panmove', function (ev) {
            maingroup.x += ev.deltaX - panstartx;
            maingroup.y += (ev.deltaY - panstarty) / 2;
            maingroup_updateT();
            panstartx = ev.deltaX;
            panstarty = ev.deltaY;
        });
        touchhammer.on('pinchend', function (ev) {
            //if (ev.scale > 2) {
            //    levelChange(1)
            //} else if (ev.scale < 0.5) {
            //    levelChange(-1)
            //}
        });



        function scrollFunc(e) {
            e = e || window.event;
            var theval;
            if (e.wheelDelta) {//IE/Opera/Chrome
                theval = e.wheelDelta / 120;
            } else if (e.detail) {//Firefox
                theval = -e.detail / 3;
            }
            levelChange(theval)
        }
        //js_main_map[0].onmousewheel = scrollFunc;//IE/Opera/Chrome/Safari

        (function () {

            var DEG2RAD = Math.PI / 180;
            var RAD2DEG = 180 / Math.PI;

            function degToRad(degrees) {
                return degrees * DEG2RAD;
            }

            function radToDeg(radians) {
                return radians * RAD2DEG;
            }

            var deviceOrientation = null;
            var sub_deviceOrientation = {
                alpha: 0,
                beta: 0,
                gamma: 0
            };
            var screenOrientation = 0;

            var onDeviceOrientationChangeEvent = function (event) {
                if (deviceOrientation != null) {
                    var beta = event.beta - deviceOrientation.beta;
                    var alpha = event.alpha - deviceOrientation.alpha;
                    var gamma = event.gamma - deviceOrientation.gamma;


                    if (beta > 180) {
                        beta = 360 - beta;
                    } else if (beta < -180) {
                        beta = 360 + beta;
                    }

                    beta > 180 ? beta = 360 - beta : (beta < -180 ? beta = 360 + beta : 0);
                    gamma > 180 ? gamma = 360 - gamma : (gamma < -180 ? gamma = 360 + gamma : 0);
                    alpha > 180 ? alpha = 360 - alpha : (alpha < -180 ? alpha = 360 + alpha : 0);


                    console.log(beta, gamma, alpha);

                    if (Math.abs(beta) > 20) {
                        beta = 0;
                    }
                    if (Math.abs(gamma) > 20) {
                        gamma = 0;
                    }
                    if (Math.abs(alpha) > 20) {
                        alpha = 0;
                    }

                    var rd_beta = degToRad(event.beta - beta / 2);
                    var rd_gamma = degToRad(event.gamma - gamma / 2);
                    var rd_alpha = degToRad(event.alpha - alpha / 2);

                    var kshu = beta;
                    var khen = 0;

                    khen += gamma * Math.cos(rd_beta) + alpha * Math.sin(rd_beta) //+ gamma * Math.sin(rd_alpha)// + alpha * Math.sin(rd_beta) + alpha * Math.cos(rd_gamma);

                    if (screenOrientation == 0) {
                        maingroup.y += (kshu * 10) / 2;
                        maingroup.x += khen * 10;
                    } else if (screenOrientation == 90) {
                        maingroup.y -= khen * 10 * 0.5;
                        maingroup.x += kshu * 10;
                    } else if (screenOrientation == -90) {
                        maingroup.y += khen * 10 * 0.5;
                        maingroup.x -= kshu * 10;
                    }

                    //console.log(kshu, khen, Math.cos(rd_beta));
                    maingroup_updateT();

                }
                deviceOrientation = event;
            };
            var onScreenOrientationChangeEvent = function () {
                screenOrientation = window.orientation || 0;
            };

            onScreenOrientationChangeEvent();
            window.addEventListener('orientationchange', onScreenOrientationChangeEvent, false);
            window.addEventListener('deviceorientation', onDeviceOrientationChangeEvent, false);

        })();



    </script>

</body>
</html>
