// author  yicheng
// yicheng-me@qq.com

var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{var a=document.createElement("canvas");return !!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(b){return false}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame;(function(f,k,b,i,j){function a(m,n){this.vector=new k.Vector3();this.screenposition=new k.Vector2();this.htmlstr=(m==null?"":m);this.calback=n;this.dom=j.createElement("div");dom.style.position="absolute"}a.prototype.flush=function(){};var d="data:image/png;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAAA8AAD/4QMqaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjUtYzAxNCA3OS4xNTE0ODEsIDIwMTMvMDMvMTMtMTI6MDk6MTUgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NTdBRTFCMDVGNjU1MTFFNTg2QUM4REUyMDU2MzkyRkUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NTdBRTFCMDZGNjU1MTFFNTg2QUM4REUyMDU2MzkyRkUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo1N0FFMUIwM0Y2NTUxMUU1ODZBQzhERTIwNTYzOTJGRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo1N0FFMUIwNEY2NTUxMUU1ODZBQzhERTIwNTYzOTJGRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pv/uAA5BZG9iZQBkwAAAAAH/2wCEAAYEBAQFBAYFBQYJBgUGCQsIBgYICwwKCgsKCgwQDAwMDAwMEAwODxAPDgwTExQUExMcGxsbHB8fHx8fHx8fHx8BBwcHDQwNGBAQGBoVERUaHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fH//AABEIACAAIAMBEQACEQEDEQH/xAGiAAAABwEBAQEBAAAAAAAAAAAEBQMCBgEABwgJCgsBAAICAwEBAQEBAAAAAAAAAAEAAgMEBQYHCAkKCxAAAgEDAwIEAgYHAwQCBgJzAQIDEQQABSESMUFRBhNhInGBFDKRoQcVsUIjwVLR4TMWYvAkcoLxJUM0U5KismNzwjVEJ5OjszYXVGR0w9LiCCaDCQoYGYSURUaktFbTVSga8uPzxNTk9GV1hZWltcXV5fVmdoaWprbG1ub2N0dXZ3eHl6e3x9fn9zhIWGh4iJiouMjY6PgpOUlZaXmJmam5ydnp+So6SlpqeoqaqrrK2ur6EQACAgECAwUFBAUGBAgDA20BAAIRAwQhEjFBBVETYSIGcYGRMqGx8BTB0eEjQhVSYnLxMyQ0Q4IWklMlomOywgdz0jXiRIMXVJMICQoYGSY2RRonZHRVN/Kjs8MoKdPj84SUpLTE1OT0ZXWFlaW1xdXl9UZWZnaGlqa2xtbm9kdXZ3eHl6e3x9fn9zhIWGh4iJiouMjY6Pg5SVlpeYmZqbnJ2en5KjpKWmp6ipqqusra6vr/2gAMAwEAAhEDEQA/APVOKuxV2KuxV2KuxV2KuxV2KuxV2KuxV2KuxV2KuxV//9k=";var h="vr360d",g,e={crossOrigin:"anonymous",clickAndDrag:false,fov:25,fovMin:8,fovMax:40,hideControls:false,lon:0,lat:90,loop:"loop",muted:true,debug:false,flatProjection:false,autoplay:true};function l(n,m){this.element=n;this.options=f.extend({},e,m);this._defaults=e;this._name=h;this.init()}l.prototype={init:function(){this._time=new Date().getTime();this._controls={};this._id=this.generateUUID();this._requestAnimationId="";this._isPhoto=false;this._isFullscreen=false;this._mouseDown=false;this._dragStart={};this._lat=this.options.lat;this._lon=this.options.lon;this._fov=this.options.fov;this._latInertia=0;this._latInertiaCath=0;this._latInertiaCath2=0;this._lonInertia=0;this._lonInertiaCath=0;this._lonInertiaCath2=0;this.paning=false;this.allowautomove=true;this.automove=true;this.movetimeout=0;this.isrendering=true;this.allowgrav=false;this.tags=[];this.tagcontainer=f("<div class='vr360tagct'></div>");this._originalWidth=f(this.element).find("canvas").width();this._originalHeight=f(this.element).find("canvas").height();f(this.element).addClass("vr360d");this.loading=f("<div class='vr-loading' style='display:none;'><span>loading...</span></div>");f(this.element).append(this.loading);this.createMediaPlayer();this.createControls()},generateUUID:function(){var n=new Date().getTime();var m="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(p){var o=(n+Math.random()*16)%16|0;n=Math.floor(n/16);return(p==="x"?o:(o&7|8)).toString(16)});return m},createMediaPlayer:function(){this._scene=new k.Scene();this._camera=new k.PerspectiveCamera(this._fov,f(this.element).width()/f(this.element).height(),20,1000);this._camera.setLens(this._fov);this._cameracontrols=new k.DeviceOrientationControls(this._camera);this.raycaster=new k.Raycaster();this.mouse=new k.Vector2();this._renderer=b.webgl?new k.WebGLRenderer({preserveDrawingBuffer:true}):new k.CanvasRenderer();this._renderer.setSize(f(this.element).width(),f(this.element).height());this._renderer.setClearColor(new k.Color(6710886));this._scene.add(new k.AmbientLight(16777215));f(this.element).append(this._renderer.domElement);this.meshgroup=new k.Group();this._scene.add(this.meshgroup);if(f(this.element).attr("data-photo-src")!=null){this._isPhoto=true;k.ImageUtils.crossOrigin=this.options.crossOrigin;this._texture=k.ImageUtils.loadTexture(d);
this.loadPhoto(f(this.element).attr("data-photo-src"))}else{this._texture=k.ImageUtils.loadTexture(d)}this._mesh=new k.Mesh(new k.SphereGeometry(500,40,40),new k.MeshBasicMaterial({map:this._texture}));this._mesh.scale.z=-1;this.meshgroup.add(this._mesh);this._mesh.material.side=k.FrontSide;this.animate()},createControls:function(){var o=this.options.muted?"fa-volume-off":"fa-volume-up";var n=this.options.autoplay?"fa-pause":"fa-play";var m='                 <div class="controls">                     <a href="#" class="playButton button fa '+n+'"></a>                     <a href="#" class="muteButton button fa '+o+'"></a>                     <a href="#" class="fullscreenButton button fa fa-expand"></a>                 </div>             ';f(this.element).append(this.tagcontainer);if(this.options.hideControls){f(this.element).find(".controls").hide()}this.attachControlEvents()},attachControlEvents:function(){var n=this;this.element.addEventListener("mousewheel",this.onMouseWheel.bind(this),false);this.element.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),false);this.element.addEventListener("mousedown",this.onPanStart.bind(this),false);this.element.addEventListener("touchstart",this.onPanStart.bind(this),false);this.element.addEventListener("mouseup",this.onPanEnd.bind(this),false);this.element.addEventListener("touchend",this.onPanEnd.bind(this),false);this._panobj={x:0,y:0},this._pinchold=1;var m=new Hammer(this.element,{threshold:0,direction:Hammer.DIRECTION_ALL});m.on("pan",this.onPan.bind(this));m.get("pan").set({threshold:0,direction:Hammer.DIRECTION_ALL});m.get("pinch").set({enable:true});m.on("pinch",this.onPinch.bind(this));m.on("pinchstart",this.onPinchStart.bind(this));f(j).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",this.fullscreen.bind(this));f(i).resize(function(){n.resizeGL(f(n.element).width(),f(n.element).height())});return;f(this.element).find(".playButton").click(function(o){o.preventDefault();if(f(this).hasClass("fa-pause")){f(this).removeClass("fa-pause").addClass("fa-play");n.pause()}else{f(this).removeClass("fa-play").addClass("fa-pause");n.play()}});f(this.element).find(".fullscreenButton").click(function(p){p.preventDefault();var o=f(n.element)[0];if(f(this).hasClass("fa-expand")){if(o.requestFullscreen){o.requestFullscreen()}else{if(o.msRequestFullscreen){o.msRequestFullscreen()}else{if(o.mozRequestFullScreen){o.mozRequestFullScreen()}else{if(o.webkitRequestFullscreen){o.webkitRequestFullscreen()}}}}}else{if(o.requestFullscreen){j.exitFullscreen()}else{if(o.msRequestFullscreen){j.msExitFullscreen()}else{if(o.mozRequestFullScreen){j.mozCancelFullScreen()}else{if(o.webkitRequestFullscreen){j.webkitExitFullscreen()}}}}}});f(this.element).find(".muteButton").click(function(o){o.preventDefault();if(f(this).hasClass("fa-volume-off")){f(this).removeClass("fa-volume-off").addClass("fa-volume-up");n._video.muted=false}else{f(this).removeClass("fa-volume-up").addClass("fa-volume-off");n._video.muted=true}})},onMouseWheel:function(n){var m=-0.01;if(n.wheelDeltaY){this._fov-=n.wheelDeltaY*m}else{if(n.wheelDelta){this._fov-=n.wheelDelta*m}else{if(n.detail){this._fov+=n.detail*1}}}if(this._fov<this.options.fovMin){this._fov=this.options.fovMin}else{if(this._fov>this.options.fovMax){this._fov=this.options.fovMax}}this._camera.setLens(this._fov);n.preventDefault()},onPanStart:function(m){this.userControl();this._lonInertia=this._latInertia=0;this._lonInertiaCath=this._latInertiaCath=this._lonInertiaCath2=this._latInertiaCath2=0;this.paning=true},onPanEnd:function(m){this.paning=false},onPan:function(o){var n=o.deltaX-this._panobj.x;var m=o.deltaY-this._panobj.y;this._panobj.x=o.deltaX;this._panobj.y=o.deltaY;this._lat+=m*4/this._fov;this._scene.rotateY(k.Math.degToRad(-n/8));this._lon+=(-n/8);if(o.isFinal){this._panobj.x=this._panobj.y=0;this.paning=false;this._lonInertia=this._lonInertiaCath2==0?n/8:this._lonInertiaCath2;this._latInertia=this._latInertiaCath2==0?m*4/this._fov:this._latInertiaCath2}else{}this._lonInertiaCath2=this._lonInertiaCath;this._lonInertiaCath=n/8;this._latInertiaCath2=this._latInertiaCath;this._latInertiaCath=m*4/this._fov;this.userControl()},onPinchStart:function(m){this._pinchold=1},onPinch:function(m){var n=m.scale/this._pinchold;this._pinchold=m.scale;this._fov*=n;if(this._fov<this.options.fovMin){this._fov=this.options.fovMin}else{if(this._fov>this.options.fovMax){this._fov=this.options.fovMax}}this._camera.setLens(this._fov);this.userControl()},userControl:function(){this.automove=false;clearTimeout(this.movetimeout);if(this.allowautomove){this.movetimeout=setTimeout(function(){if(this.allowautomove){this.automove=true}}.bind(this),5000)}},animate:function(){if(this.allowgrav){this._cameracontrols.update()}this.render();this._requestAnimationId=requestAnimationFrame(this.animate.bind(this))},render:function(){if(!this.isrendering){return}TWEEN.update();if(this.automove){var o=90-this._lat;if(o!=0){if(o>0.08){o=0.08}else{if(o<-0.08){o=-0.08
}else{o=o/2;Math.abs(o)<0.01?o=0:0}}this._latInertia=o}if(this._lonInertia==0){this._lonInertia=0.005}else{if(Math.abs(this._lonInertia)<0.06){this._lonInertia*=1.02}else{if(Math.abs(this._lonInertia)>0.06){this._lonInertia=0.06}}}}if(!this.paning){this._scene.rotateY(k.Math.degToRad(-this._lonInertia));this._lon-=this._lonInertia;this._lat+=this._latInertia;if(!this.automove){this._lonInertia*=0.96;this._latInertia*=0.96}Math.abs(this._lonInertia)<0.001?this._lonInertia=0:0;Math.abs(this._latInertia)<0.001?this._latInertia=0:0}this._lat=Math.max(0,Math.min(180,this._lat));var p=new k.Euler();p.set(k.Math.degToRad(this._lat),0,0,"YXZ");if(this.allowgrav){var n=new k.Quaternion();n.setFromEuler(p);this._camera.quaternion.multiply(n)}else{var m=new k.Quaternion(-Math.sqrt(0.5),0,0,Math.sqrt(0.5));this._camera.quaternion.setFromEuler(p);this._camera.quaternion.multiply(m)}if(!this.options.flatProjection){this._camera.position.set(0,0,1);this._camera.position.applyQuaternion(this._camera.quaternion);this._camera.position.multiplyScalar(450)}else{this._camera.position.set(0,0,0)}this._renderer.render(this._scene,this._camera)},moveTags:function(){var u=new k.Vector3(0,1,0);var o=this._scene.quaternion.clone().conjugate();u.applyQuaternion(this._camera.quaternion);u.applyQuaternion(o);var t=this._camera.rotation.toVector3();t.applyQuaternion(o);var n=u.clone().cross(t).normalize();var F=new k.Vector3(0,0,1).applyQuaternion(this._camera.quaternion).multiplyScalar(500);var z=this._camera.position.clone().applyQuaternion(o);var B=this._renderer.domElement.height/2;var s=this._renderer.domElement.width/2;var C=B/Math.tan(k.Math.degToRad(this._camera.fov/2));for(var D=0;D<this.tags.length;D++){var r=this.tags[D];var A=r.position;var H=A.distanceTo(z);if(H<300){r.dom.css({"top":this._renderer.domElement.height*2+"px","left":"0px"});continue}var x=new k.Vector3().subVectors(A,z);var m=x.clone().projectOnPlane(n);var G=x.angleTo(n);var E=Math.tan(G)*C;var w=m.angleTo(t);var p=m.angleTo(u);var q=Math.cos(w)*E;r.dom.css("left",q+s+"px");var y=Math.tan(w)*q;if((p<1.5707&&y>0)||(p>1.5707&&y<0)){y=-y}r.dom.css("top",y+B+"px")}},loadPhoto:function(n){var m=new Image();this.loading.show();var o=this;m.crossOrigin="Anonymous";m.onload=function(){o._texture.image=this;o._texture.needsUpdate=true;setTimeout(function(){o.loading.hide()},100)};m.src=n;this._texture.sourceFile=n;this._fov=this.options.fov},addTag:function(q,m,s,n){if(n){var p=f(m)}else{var p=f("<div class='vr360tag'></div>");p.html(m)}if(q instanceof Array){var r=new k.Vector3(q[0],q[1],q[2])}else{var r=new k.Vector3(q.x,q.y,q.z)}if(s instanceof Function){p.click(s)}var o={position:r,htmlstr:m,calback:s,dom:p};this.tags.push(o);this.tagcontainer.append(p)},clearAllTag:function(){for(var m=0;m<this.tags.length;m++){this.tags[m].dom.remove()}this.tags=[]},lookAt:function(m){var s=new k.Vector3(m.x,m.y,m.z);console.log(s);new TWEEN.Tween(this).to({_fov:80},1000).start();var q=s.angleTo(this._camera.up);var r=s.projectOnPlane(this._camera.up).normalize();var n=r.angleTo(new k.Vector3(0,0,1));var p=r.angleTo(new k.Vector3(1,0,0));var o=0;if(p>1.5707){if(n>1.5707){o=n-Math.PI}else{o=-n}}else{if(n>1.5707){o=Math.PI-n}else{o=n}}if(Math.abs(this._scene.rotation.z)<=1.5707){if(n<1.5707){o=-3.1415-o}else{}}else{if(n<1.5707){}else{o=-3.1415-o}}this._scene.rotation.y=o;this._lat=180-k.Math.radToDeg(q)},getVector:function(m,q){var o=this.mouse;o.x=(m/this._renderer.domElement.width)*2-1;o.y=-(q/this._renderer.domElement.height)*2+1;this.raycaster.setFromCamera(o,this._camera);var p=this.raycaster.intersectObject(this._mesh,true);if(p.length>0){var n=new k.Vector3(p[0].point.x,p[0].point.y,p[0].point.z);n.applyQuaternion(this._scene.quaternion.clone().conjugate());return n}return null},fullscreen:function(){if(f(this.element).find("a.fa-expand").length>0){this.resizeGL(screen.width,screen.height);f(this.element).addClass("fullscreen");f(this.element).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress");this._isFullscreen=true}else{this.resizeGL(this._originalWidth,this._originalHeight);f(this.element).removeClass("fullscreen");f(this.element).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand");this._isFullscreen=false}},resizeGL:function(m,n){this._renderer.setSize(m,n);this._camera.aspect=m/n;this._camera.updateProjectionMatrix()},destroy:function(){i.cancelAnimationFrame(this._requestAnimationId);this._requestAnimationId="";this._texture.dispose();this._scene.remove(this._mesh);if(this._isVideo){this.unloadVideo()}f(this._renderer.domElement).remove()},};f.fn[h]=function(m){return this.each(function(n,o){if(typeof m==="object"||!m){this.plugin=new l(this,m);if(!f.data(this,"plugin_"+h)){f.data(this,"plugin_"+h,this.plugin)}}else{if(this.plugin[m]){return this.plugin[m].apply(this.plugin,Array.prototype.slice.call(arguments,1))}}})};var c={"VERSION":"1.0",};f[h]=c})(jQuery,THREE,Detector,window,document);